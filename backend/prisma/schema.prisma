generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           String              @id @default(cuid())
  email                        String              @unique
  name                         String
  password                     String
  gender                       Gender
  role                         UserRole
  studentId                    String?             @unique
  phone                        String?
  address                      String?
  isProfileComplete            Boolean             @default(false)
  createdAt                    DateTime            @default(now())
  updatedAt                    DateTime            @updatedAt
  sentMessages                 ChatMessage[]
  createdClasses               Class[]             @relation("ClassTeacher")
  quizSubmissions              QuizSubmission[]
  enrollments                  StudentEnrollment[]
  groupMemberships             GroupMember[]
  aiGroupings                  AIGrouping[]
  studentEngagementMetrics     StudentEngagementMetric[]
  longitudinalPerformances     LongitudinalPerformance[]
  researchDataExports          ResearchDataExport[]
  analyticsSessions            AnalyticsSession[]
}

model Class {
  id                           String              @id @default(cuid())
  name                         String
  classCode                    String              @unique
  teacherId                    String
  posttestUsesPretestQuestions Boolean             @default(false)
  status                       ClassStatus         @default(ACTIVE)
  groupingRationale            String?
  lastGroupedAt                DateTime?
  retentionTestDelayMinutes    Int?
  postTestDelayMinutes         Int?
  classEndedAt                 DateTime?
  createdAt                    DateTime            @default(now())
  updatedAt                    DateTime            @updatedAt
  teacher                      User                @relation("ClassTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  materials                    Material[]
  posttest                     Quiz?               @relation("PosttestForClass")
  pretest                      Quiz?               @relation("PretestForClass")
  retentionTest                Quiz?               @relation("RetentionTestForClass")
  enrollments                  StudentEnrollment[]
  groups                       Group[]
  aiGroupings                  AIGrouping[]
  groupPerformanceMetrics      GroupPerformanceMetric[]
  aiAlgorithmInsights          AIAlgorithmInsight[]
  studentEngagementMetrics     StudentEngagementMetric[]
  longitudinalPerformances     LongitudinalPerformance[]
  researchDataExports          ResearchDataExport[]
  analyticsSessions            AnalyticsSession[]
}

model StudentEnrollment {
  id                String  @id @default(cuid())
  classId           String
  studentId         String
  groupNumber       Int?
  pretestScore      Float?
  posttestScore     Float?
  posttestCompletedAt DateTime?
  retentionScore    Float?
  groupingRationale String?
  class             Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  student           User    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
}

model Material {
  id        String       @id @default(cuid())
  classId   String
  type      MaterialType
  title     String
  url       String
  createdAt DateTime     @default(now())
  class     Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
}

model Quiz {
  id                    String           @id @default(cuid())
  title                 String
  timeLimitMinutes      Int
  availableFrom         DateTime?
  type                  QuizType
  classId_pretest       String?          @unique
  classId_posttest      String?          @unique
  classId_retentionTest String?          @unique
  questions             Question[]
  posttestForClass      Class?           @relation("PosttestForClass", fields: [classId_posttest], references: [id])
  pretestForClass       Class?           @relation("PretestForClass", fields: [classId_pretest], references: [id])
  retentionTestForClass Class?           @relation("RetentionTestForClass", fields: [classId_retentionTest], references: [id])
  submissions           QuizSubmission[]
}

model Question {
  id                 String   @id @default(cuid())
  quizId             String
  text               String
  options            String[]
  correctAnswerIndex Int
  quiz               Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model QuizSubmission {
  id          String   @id @default(cuid())
  quizId      String
  studentId   String
  score       Float
  submittedAt DateTime @default(now())
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model GroupNote {
  id        String   @id @default(cuid())
  classId   String
  groupId   Int
  content   String   @default("")
  updatedAt DateTime @updatedAt

  @@unique([classId, groupId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  classId   String
  groupId   Int?
  senderId  String
  text      String
  isAI      Boolean  @default(false)
  timestamp DateTime @default(now())
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
}

model Group {
  id                           String    @id @default(cuid())
  classId                      String
  name                         String
  aiGenerated                  Boolean   @default(false)
  rationale                    String?
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt
  class                        Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  members                      GroupMember[]
  groupPerformanceMetrics      GroupPerformanceMetric[]
  studentEngagementMetrics     StudentEngagementMetric[]
}

model GroupMember {
  id         String   @id @default(cuid())
  groupId    String
  studentId  String
  assignedAt DateTime @default(now())
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  student    User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
}

model AIGrouping {
  id                    String   @id @default(cuid())
  classId               String
  teacherId             String
  groupingData          Json
  rationale             String
  algorithmVersion      String @default("1.0.0")
  status                AIGroupingStatus @default(PENDING)
  createdAt             DateTime @default(now())
  appliedAt             DateTime?
  class                 Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher               User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  aiAlgorithmInsights   AIAlgorithmInsight[]
}

enum UserRole {
  TEACHER
  STUDENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaterialType {
  pdf
  docx
  youtube
}

enum QuizType {
  PRETEST
  POSTTEST
  RETENTION_TEST
}

enum ClassStatus {
  ACTIVE
  MAIN_SESSION
  GROUP_SESSION
  POSTTEST
  COMPLETED
}

enum AIGroupingStatus {
  PENDING
  APPLIED
  REJECTED
}

// Analytics Schema Extensions for BioLearn AI Phase 4

// Analytics tracking for group performance over time
model GroupPerformanceMetric {
  id                String                    @id @default(cuid())
  classId           String
  groupId           String
  metricType        PerformanceMetricType
  value             Float
  calculatedAt      DateTime                  @default(now())
  periodStart       DateTime                  // Start of the measurement period
  periodEnd         DateTime                  // End of the measurement period
  metadata          Json?                     // Additional context (sample size, confidence, etc.)
  class             Class                     @relation(fields: [classId], references: [id], onDelete: Cascade)
  group             Group                     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([classId, metricType, calculatedAt])
  @@index([groupId, metricType, calculatedAt])
}

// AI algorithm effectiveness tracking
model AIAlgorithmInsight {
  id                    String                @id @default(cuid())
  classId               String
  aiGroupingId          String
  algorithmVersion      String
  effectivenessScore    Float                 // 0-1 score indicating algorithm effectiveness
  genderBalanceScore    Float                 // 0-1 score for gender balance achievement
  abilityMixScore       Float                 // 0-1 score for mixed-ability distribution
  teacherSatisfaction   Float?                // Optional teacher rating (1-5 scale)
  improvementAreas    String[]              // Array of identified improvement areas
  calculatedAt          DateTime              @default(now())
  class                 Class                 @relation(fields: [classId], references: [id], onDelete: Cascade)
  aiGrouping            AIGrouping            @relation(fields: [aiGroupingId], references: [id], onDelete: Cascade)

  @@index([classId, calculatedAt])
  @@index([aiGroupingId])
  @@index([algorithmVersion, calculatedAt])
}

// Student engagement and participation tracking
model StudentEngagementMetric {
  id                String                    @id @default(cuid())
  studentId         String
  classId           String
  groupId           String?
  metricType        EngagementMetricType
  value             Float                     // Normalized engagement score (0-1)
  sessionStart      DateTime                  // Session or period start
  sessionEnd        DateTime                  // Session or period end
  metadata          Json?                     // Additional context (activities, interactions, etc.)
  recordedAt        DateTime                  @default(now())
  student           User                      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class             Class                     @relation(fields: [classId], references: [id], onDelete: Cascade)
  group             Group?                    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([studentId, classId, metricType, recordedAt])
  @@index([classId, metricType, recordedAt])
  @@index([groupId, metricType, recordedAt])
}

// Longitudinal performance tracking for research
model LongitudinalPerformance {
  id                String                    @id @default(cuid())
  studentId         String
  classId           String
  academicYear      String                    // e.g., "2024-2025"
  semester          String?                   // e.g., "Fall", "Spring", "Summer"
  pretestScore      Float?
  posttestScore     Float?
  retentionScore    Float?
  improvementRate   Float?                    // Calculated improvement from pre to post
  retentionRate     Float?                    // Calculated retention from post to retention
  groupingHistory   Json?                     // Array of group assignments and rationale
  recordedAt        DateTime                  @default(now())
  student           User                      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class             Class                     @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, academicYear])
  @@index([studentId, academicYear])
  @@index([classId, academicYear])
}

// Research data export tracking and metadata
model ResearchDataExport {
  id                String                    @id @default(cuid())
  classId           String
  teacherId         String
  exportType        ExportType
  fileFormat        ExportFormat
  anonymizationLevel AnonymizationLevel       @default(NONE)
  recordCount       Int                       // Number of records in export
  fileSize          Int?                      // File size in bytes
  fileHash          String?                   // SHA256 hash for integrity verification
  downloadUrl     String?                   // Temporary secure download URL
  expiresAt         DateTime?                 // URL expiration time
  status            ExportStatus              @default(PENDING)
  metadata          Json?                     // Export configuration and filters
  createdAt         DateTime                  @default(now())
  completedAt       DateTime?
  class             Class                     @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher           User                      @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([classId, createdAt])
  @@index([teacherId, createdAt])
  @@index([status, createdAt])
}

// Real-time analytics session tracking
model AnalyticsSession {
  id                String                    @id @default(cuid())
  classId           String
  teacherId         String
  sessionType       AnalyticsSessionType
  startTime         DateTime                  @default(now())
  endTime           DateTime?
  duration          Int?                      // Duration in seconds
  metricsViewed     String[]                  // Array of metric types viewed
  filtersApplied    Json?                     // Applied filters and parameters
  exportCount       Int                       @default(0) // Number of exports during session
  lastActivity      DateTime                  @default(now())
  class             Class                     @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher           User                      @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([classId, startTime])
  @@index([teacherId, startTime])
  @@index([sessionType, startTime])
}

// Performance metric types
enum PerformanceMetricType {
  GROUP_AVERAGE_SCORE      // Average score for group members
  GROUP_IMPROVEMENT_RATE   // Average improvement from pre to post test
  GROUP_RETENTION_RATE     // Average retention score vs posttest
  GROUP_COLLABORATION_SCORE // Collaboration effectiveness metric
  GROUP_PARTICIPATION_RATE // Average participation across members
  GROUP_GENDER_BALANCE     // Gender distribution within group
  GROUP_ABILITY_DISTRIBUTION // High/medium/low performer balance
}

// Engagement metric types
enum EngagementMetricType {
  PARTICIPATION_RATE       // Active participation in activities
  COLLABORATION_FREQUENCY  // Interactions with group members
  QUESTION_ASKING_RATE     // Frequency of asking questions
  HELP_SEEKING_BEHAVIOR    // Requests for assistance
  HELP_PROVIDING_BEHAVIOR  // Assistance provided to others
  MATERIAL_ACCESS_RATE     // Access to learning materials
  SESSION_ATTENDANCE       // Attendance tracking
}

// Export types for research data
enum ExportType {
  GROUP_PERFORMANCE        // Group-level performance metrics
  INDIVIDUAL_PERFORMANCE   // Individual student performance
  LONGITUDINAL_DATA        // Long-term performance tracking
  AI_ALGORITHM_INSIGHTS    // AI grouping effectiveness data
  COMPREHENSIVE_DATASET    // All available analytics data
}

// Export file formats
enum ExportFormat {
  CSV                     // Comma-separated values
  JSON                    // JavaScript Object Notation
  EXCEL                   // Microsoft Excel format
  TSV                     // Tab-separated values
}

// Anonymization levels for privacy protection
enum AnonymizationLevel {
  NONE                    // No anonymization (full data)
  PSEUDONYMIZED          // Replace identifiers with pseudonyms
  ANONYMIZED             // Remove all identifying information
  AGGREGATED_ONLY        // Only aggregated statistics
}

// Export processing status
enum ExportStatus {
  PENDING                 // Export queued for processing
  PROCESSING              // Currently being generated
  COMPLETED               // Export completed successfully
  FAILED                  // Export failed with error
  EXPIRED                 // Export expired (too old)
}

// Analytics session types
enum AnalyticsSessionType {
  GROUP_PERFORMANCE       // Viewing group performance metrics
  AI_INSIGHTS             // Viewing AI algorithm insights
  LONGITUDINAL_ANALYSIS   // Analyzing longitudinal data
  RESEARCH_EXPORT         // Generating research data exports
  COMPREHENSIVE_DASHBOARD // Full dashboard usage
}
